# 📊 نظام المحاسبة - OFOQ Accounting Module

## ✅ الملفات المنشأة

تم إنشاء جميع صفحات نظام المحاسبة بنجاح:

### 📄 الصفحات الرئيسية
1. **accounting.html** - لوحة التحكم الرئيسية للمحاسبة
2. **inventory.html** - إدارة المخزون
3. **sales.html** - إدارة المبيعات
4. **pos-scanner.html** - نقطة البيع مع ماسح الباركود
5. **sale-review.html** - مراجعة البيع قبل التأكيد
6. **invoices.html** - إدارة الفواتير
7. **invoice-form.html** - فاتورة شراء يدوية

### 🗄️ قاعدة البيانات
8. **create-accounting-tables.sql** - ✅ تم تنفيذها (6 جداول مع RLS والمشغلات)
9. **add-accounting-service.sql** - لإضافة خدمة المحاسبة للشركات

---

## 🚀 كيفية البدء

### الخطوة 1️⃣: تفعيل خدمة المحاسبة للشركة
قم بتشغيل الأمر SQL التالي في Supabase لتفعيل خدمة المحاسبة:

```sql
-- أولاً: إضافة خدمة المحاسبة
INSERT INTO services (name, description)
VALUES ('accounting', 'خدمة المحاسبة - إدارة المخزون، المبيعات، والفواتير')
ON CONFLICT (name) DO NOTHING;

-- ثانياً: تفعيل الخدمة للشركة (استبدل COMPANY_USER_ID)
INSERT INTO company_services (company_id, service_id, is_active)
SELECT 
    'YOUR_COMPANY_USER_ID'::uuid,
    id,
    true
FROM services
WHERE name = 'accounting'
ON CONFLICT (company_id, service_id) 
DO UPDATE SET is_active = true;
```

### الخطوة 2️⃣: الوصول للنظام
1. سجل الدخول كشركة (Company)
2. ستظهر بطاقة "المحاسبة" في لوحة التحكم الرئيسية
3. انقر عليها للدخول لنظام المحاسبة

---

## 📦 الميزات الرئيسية

### 🏪 إدارة المخزون
- ✅ إضافة/تعديل/حذف المنتجات
- ✅ تتبع الكميات والأسعار
- ✅ تنبيهات المخزون المنخفض (تلوين أحمر تلقائي)
- ✅ وظيفة تعبئة المخزون (Refill)
- ✅ البحث برمز المنتج أو الاسم
- ✅ سجل حركة المخزون (Audit Log)

**كيفية الاستخدام:**
1. افتح `inventory.html`
2. انقر "إضافة منتج"
3. أدخل: رمز المنتج، الاسم، سعر الشراء، سعر البيع، الكمية، الحد الأدنى
4. عند انخفاض الكمية تحت الحد الأدنى → سيظهر المنتج بلون أحمر تلقائياً
5. استخدم زر "تعبئة" لإضافة كميات جديدة

### 🛒 نقطة البيع (POS)
- ✅ ماسح الباركود/QR Code (باستخدام الكاميرا)
- ✅ إدخال يدوي لرموز المنتجات
- ✅ سلة مشتريات تفاعلية
- ✅ التحقق التلقائي من المخزون
- ✅ صفحة مراجعة قبل التأكيد
- ✅ خصم تلقائي من المخزون عند البيع
- ✅ إنشاء فاتورة بيع تلقائياً

**سير العمل:**
1. افتح `pos-scanner.html` من صفحة المبيعات
2. امسح الباركود بالكاميرا أو أدخل رمز المنتج يدوياً
3. أضف جميع المنتجات للسلة
4. انقر "متابعة للدفع"
5. راجع البيع في صفحة `sale-review.html`
6. اختر حالة الدفع (مدفوع/معلق)
7. انقر "تأكيد البيع"
8. سيتم تلقائياً:
   - خصم الكميات من المخزون
   - إنشاء سجل بيع
   - إنشاء فاتورة بيع
   - تسجيل الحركة في سجل المخزون

### 📄 الفواتير
- ✅ عرض جميع الفواتير (بيع + شراء)
- ✅ فلترة حسب النوع وحالة الدفع
- ✅ البحث برقم الفاتورة
- ✅ عرض تفاصيل الفاتورة
- ✅ طباعة الفواتير
- ✅ فواتير البيع تُنشأ تلقائياً
- ✅ فواتير الشراء يدوية

**إنشاء فاتورة شراء:**
1. افتح `invoices.html`
2. انقر "فاتورة شراء يدوية"
3. أضف المنتجات من المخزون
4. أدخل الكميات والأسعار
5. احفظ الفاتورة
6. سيتم تلقائياً إضافة الكميات للمخزون

---

## 🗂️ هيكل قاعدة البيانات

### الجداول المنشأة:

1. **inventory** - المخزون
   - `id`, `company_id`, `product_code`, `product_name`
   - `purchase_price`, `selling_price`, `total_quantity`
   - `min_quantity_alert`, `is_low_stock` (محسوب تلقائياً)

2. **sales** - المبيعات
   - `id`, `company_id`, `sale_number`, `total_amount`
   - `payment_status`, `sale_date`

3. **sale_items** - تفاصيل المبيعات
   - `id`, `sale_id`, `product_code`, `product_name`
   - `quantity`, `unit_price`, `subtotal`

4. **invoices** - الفواتير
   - `id`, `company_id`, `invoice_number`, `invoice_type` (sale/purchase)
   - `total_amount`, `payment_status`, `sale_id`, `notes`

5. **invoice_items** - تفاصيل الفواتير
   - `id`, `invoice_id`, `product_code`, `product_name`
   - `quantity`, `unit_price`, `subtotal`

6. **inventory_transactions** - سجل حركة المخزون
   - `id`, `company_id`, `product_code`, `transaction_type`
   - `quantity`, `previous_quantity`, `new_quantity`
   - `reference_id`, `notes`

### المشغلات (Triggers):
- ✅ `create_invoice_from_sale()` - إنشاء فاتورة عند البيع
- ✅ `copy_sale_items_to_invoice()` - نسخ منتجات البيع للفاتورة

### سياسات الأمان (RLS):
- ✅ كل شركة ترى بياناتها فقط
- ✅ سياسات SELECT, INSERT, UPDATE, DELETE على جميع الجداول

---

## 🎯 ميزات متقدمة

### التنبيهات التلقائية
- **المخزون المنخفض**: المنتجات تحت الحد الأدنى تُعرض بلون أحمر في أعلى القائمة
- **حالة الدفع**: ألوان مختلفة للحالات (أخضر=مدفوع، أصفر=معلق، أحمر=ملغي)

### سجل المخزون (Audit Trail)
جميع العمليات تُسجل تلقائياً:
- تعبئة المخزون (refill)
- البيع (sale)
- الشراء (purchase)
- التعديل اليدوي (adjustment)

### ماسح الباركود
- استخدام مكتبة `html5-qrcode`
- دعم QR Code و Barcode
- إدخال يدوي كبديل
- مسح مستمر لعدة منتجات

---

## 🔒 الأمان

- ✅ **Row Level Security (RLS)** على جميع الجداول
- ✅ التحقق من الدور (Role) = `company`
- ✅ كل شركة ترى بياناتها فقط
- ✅ التحقق من المخزون قبل البيع
- ✅ منع البيع بكميات أكبر من المتوفر

---

## 📱 التوافق

- ✅ تصميم متجاوب (Responsive)
- ✅ دعم الهواتف والأجهزة اللوحية
- ✅ دعم كاميرا الهاتف لمسح الباركود
- ✅ واجهة عربية كاملة (RTL)

---

## 🎨 التصميم

- **الألوان الرئيسية:**
  - البرتقالي: `#D97706` (الأزرار والعناصر الفعالة)
  - الداكن: `#1E293B` (العناوين)
  - الأزرق: `#344663` (الأزرار الثانوية)
  - الأخضر: `#28a745` (النجاح والحفظ)
  - الأحمر: `#dc3545` (التحذيرات والحذف)

- **الخطوط:**
  - Cairo (خط عربي احترافي)

---

## 📊 الإحصائيات

لوحة التحكم الرئيسية (`accounting.html`) تعرض:
- ✅ إجمالي المنتجات
- ✅ مبيعات اليوم
- ✅ عدد المنتجات المنخفضة
- ✅ الفواتير المعلقة

---

## 🛠️ التخصيص

### تغيير الحد الأدنى الافتراضي للمخزون:
في `inventory.html` → السطر: `value="10"` في حقل الحد الأدنى

### تعديل صيغة رقم الفاتورة:
في `sale-review.html` و `invoice-form.html`:
```javascript
const invoiceNumber = 'INV-SALE-' + new Date().toISOString()...
```

### تخصيص طباعة الفواتير:
في `invoices.html` → قسم `@media print`

---

## ⚠️ ملاحظات مهمة

1. **ماسح الباركود** يحتاج إذن الكاميرا من المتصفح
2. **التاريخ** يستخدم التقويم الميلادي (Gregory) وليس الهجري
3. **الأسعار** بالريال العماني (OMR) بـ 3 خانات عشرية
4. **حذف المبيعات** لا يعيد الكميات للمخزون (للحماية)
5. **حذف الفواتير** يحذف التفاصيل المرتبطة تلقائياً (CASCADE)

---

## 🐛 استكشاف الأخطاء

### المشكلة: لا تظهر بطاقة المحاسبة في الرئيسية
**الحل**: تأكد من تنفيذ `add-accounting-service.sql` وتفعيل الخدمة للشركة

### المشكلة: الكاميرا لا تعمل في ماسح الباركود
**الحل**: 
- تأكد من منح إذن الكاميرا للمتصفح
- استخدم HTTPS أو localhost
- استخدم الإدخال اليدوي كبديل

### المشكلة: خطأ RLS عند الحفظ
**الحل**: تأكد من تنفيذ جميع سياسات RLS في `create-accounting-tables.sql`

---

## 📞 الدعم الفني

للمساعدة أو الاستفسارات، راجع:
- 📄 `ACCOUNTING_MODULE_PLAN.md` - خطة التطوير الكاملة
- 🗃️ `create-accounting-tables.sql` - بنية قاعدة البيانات

---

## ✨ التطويرات المستقبلية

- [ ] إضافة تقارير مالية
- [ ] تصدير البيانات (Excel/PDF)
- [ ] إشعارات البريد الإلكتروني للمخزون المنخفض
- [ ] دعم عملات متعددة
- [ ] نظام الخصومات والعروض
- [ ] تكامل مع طابعة الفواتير الحرارية

---

**تم بناء النظام بواسطة GitHub Copilot** ✅
**التاريخ**: أكتوبر 2025
**الإصدار**: 1.0.0
