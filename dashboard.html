<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أُفُق - الرئيسية</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1E293B;
            --primary-orange: #D97706;
            --secondary-orange: #D9882E;
            --accent-blue: #344663;
            --light-orange: #D89955;
            --medium-blue: #49648A;
            --pale-orange: #D8AA7D;
            --soft-blue: #5F81B2;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --border-gray: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--primary-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 5px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo img {
            width: 150px;
            height: auto;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .main-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .option-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
            border-color: var(--primary-orange);
        }

        .option-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--primary-orange);
        }

        .option-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .option-description {
            color: var(--accent-blue);
            font-size: 16px;
        }

        /* Responsive styles for new header layout */
        @media (max-width: 768px) {
            .header-images-row {
                flex-direction: column !important;
                gap: 15px;
                text-align: center;
            }
            
            .header-info-row {
                flex-direction: column !important;
                gap: 15px;
                text-align: center;
            }
            
            .header-info-row > div {
                width: 100%;
                justify-content: center !important;
            }
        }

        @media (max-width: 480px) {
            .header-images-row img {
                width: 80px !important;
                height: 80px !important;
            }
            
            .header-info-row span {
                font-size: 14px !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- First Section: Official Images Row -->
            <div class="header-images-row" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #e9ecef;">
                <!-- Left: Oman Vision Logo -->
                <div style="display: flex; align-items: center;">
                    <img src="OmanVision.webp" alt="Oman Vision 2040" style="width: 140px; height: auto;">
                </div>

                <!-- Center: Sultan Images -->
                <div style="display: flex; gap: 20px; align-items: center;">
                    <img src="2.jpg" alt="Sultan Haitham" style="border-radius: 50%; width: 100px; height: 100px; border: solid #1E293B 3px;">
                    <img src="HM_Sultan_Qaboos.jpg" alt="Sultan Kaboos" style="border-radius: 50%; width: 100px; height: 100px; border: solid #1E293B 3px;">
                </div>

                <!-- Right: Chamber Logo -->
                <div style="display: flex; align-items: center;">
                    <img src="Oman-Chamber-of-Commerce-and-Industry.png" alt="Chamber Logo" style="width: 120px; height: auto;">
                </div>
            </div>

            <!-- Second Section: Logo and Contact Info Row -->
            <div class="header-info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
                <!-- Left: OFOQ Logo -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="iconWithArabic (2).svg" alt="OFOQ Logo" style="width: 80px; height: auto;">
                </div>

                <!-- Center: Address Info -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; color: #1E293B; margin-bottom: 2px;">شارع غلا</div>
                        <div style="font-size: 14px; font-weight: 700; color: #1E293B;">مسقط، عُمان</div>
                    </div>
                    <span style="background: #f8f9fa; border-radius: 50%; padding: 8px; margin-left: 8px;">
                        <i class="fa fa-home" style="color: #D97706; font-size: 18px;"></i>
                    </span>
                </div>

                <!-- Center-Right: Working Hours -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; color: #1E293B; margin-bottom: 2px;">الأحد - الخميس</div>
                        <div style="font-size: 14px; font-weight: 700; color: #1E293B;">9 صباحاً - 6 مساءً</div>
                    </div>
                    <span style="background: #f8f9fa; border-radius: 50%; padding: 8px; margin-left: 8px;">
                        <i class="fa fa-clock" style="color: #D97706; font-size: 18px;"></i>
                    </span>
                </div>

                <!-- Right: Contact Info & Logout -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; font-weight: 600; color: #1E293B; margin-bottom: 2px;">اتصل بنا الآن</div>
                            <div style="font-size: 14px; font-weight: 700; color: #1E293B;">+968 98765432</div>
                        </div>
                        <span style="background: #f8f9fa; border-radius: 50%; padding: 8px; margin-left: 8px;">
                            <i class="fa fa-phone" style="color: #D97706; font-size: 18px;"></i>
                        </span>
                    </div>
                    <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                        <span id="welcomeUser" style="font-size: 14px; color: #1E293B;">مرحباً، </span>
                        <button class="logout-btn" onclick="logout()" style="padding: 8px 16px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600;">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-options" id="servicesContainer">
            <!-- Services will be dynamically loaded based on company's activated services -->
            <div class="loading-message">جاري تحميل الخدمات المتاحة...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://wlnukwaecpkhxomfgxni.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbnVrd2FlY3BraHhvbWZneG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDc4MjEsImV4cCI6MjA3NDIyMzgyMX0.PW3GVs3l15oBIa8rS86offziTFkSVefj5OFUc6XRmoA'
        );

        // Authentication and data classes
        class AuthService {
            static async getCurrentUser() {
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    return user;
                } catch (error) {
                    console.error('Get current user error:', error);
                    return null;
                }
            }
            
            static async getUserRole() {
                try {
                    const user = await this.getCurrentUser();
                    if (!user) return null;
                    
                    const { data, error } = await supabaseClient
                        .from('user_profiles')
                        .select('role')
                        .eq('id', user.id)
                        .single();
                    
                    if (error) throw error;
                    
                    return data?.role || null;
                } catch (error) {
                    console.error('Get user role error:', error);
                    return null;
                }
            }
            
            static async signOut() {
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        class CompanyDataService {
            static async getCompanyInfo() {
                try {
                    const user = await AuthService.getCurrentUser();
                    if (!user) throw new Error('User not authenticated');
                    
                    const { data, error } = await supabaseClient
                        .from('user_profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (error) throw error;
                    
                    // Get active services for the company
                    const { data: services, error: servicesError } = await supabaseClient
                        .from('company_services')
                        .select(`
                            services (name)
                        `)
                        .eq('company_id', user.id)
                        .eq('is_active', true);
                    
                    if (servicesError) {
                        console.warn('Could not load services:', servicesError);
                    }
                    
                    // Extract service names
                    const activeServices = services ? services.map(s => s.services.name) : [];
                    
                    return {
                        ...data,
                        active_services: activeServices
                    };
                } catch (error) {
                    console.error('Get company info error:', error);
                    return null;
                }
            }
        }
        let currentUser = null;
        let companyInfo = null;

        // Service definitions
        const availableServices = {
            hr: {
                title: 'الموارد البشرية',
                description: 'إدارة شؤون الموظفين والرواتب والحضور والانصراف',
                icon: 'fas fa-users',
                action: 'goToManagement'
            },
            accounting: {
                title: 'المحاسبة',
                description: 'إدارة المخزون، المبيعات، والفواتير',
                icon: 'fas fa-calculator',
                action: 'goToAccounting'
            },
            inventory: {
                title: 'إدارة المخزون',
                description: 'تتبع المواد والبضائع والمخزون',
                icon: 'fas fa-boxes',
                action: 'goToInventory'
            },
            sales: {
                title: 'المبيعات',
                description: 'إدارة عمليات البيع والعملاء',
                icon: 'fas fa-chart-line',
                action: 'goToSales'
            },
            invoices: {
                title: 'الفواتير',
                description: 'إنشاء وإدارة الفواتير والحسابات',
                icon: 'fas fa-file-invoice',
                action: 'goToFinancial'
            }
        };

        // Initialize dashboard
        window.addEventListener('load', async function() {
            // Check authentication
            currentUser = await AuthService.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Verify user role
            const userRole = await AuthService.getUserRole();
            if (userRole !== 'company') {
                window.location.href = 'login.html';
                return;
            }

            // Load company information
            try {
                companyInfo = await CompanyDataService.getCompanyInfo();
                if (companyInfo) {
                    document.getElementById('welcomeUser').textContent = 'مرحباً، ' + companyInfo.company_name;
                    await loadActivatedServices();
                } else {
                    showError('خطأ في تحميل بيانات الشركة');
                }
            } catch (error) {
                console.error('Load company info error:', error);
                showError('حدث خطأ في تحميل البيانات');
            }
        });

        // Load activated services for company
        async function loadActivatedServices() {
            const servicesContainer = document.getElementById('servicesContainer');
            
            if (!companyInfo.active_services || companyInfo.active_services.length === 0) {
                servicesContainer.innerHTML = `
                    <div class="no-services-message" style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 20px; color: #ddd;"></i>
                        <h3>لا توجد خدمات مفعلة</h3>
                        <p>يرجى الاتصال بالإدارة لتفعيل الخدمات المطلوبة</p>
                    </div>
                `;
                return;
            }

            let servicesHtml = '';
            companyInfo.active_services.forEach(serviceKey => {
                if (availableServices[serviceKey]) {
                    const service = availableServices[serviceKey];
                    servicesHtml += `
                        <div class="option-card" onclick="${service.action}()">
                            <div class="option-icon">
                                <i class="${service.icon}"></i>
                            </div>
                            <h3 class="option-title">${service.title}</h3>
                            <p class="option-description">${service.description}</p>
                        </div>
                    `;
                }
            });

            servicesContainer.innerHTML = servicesHtml;
        }

        // Navigation functions
        window.goToManagement = function() {
            if (hasService('hr')) {
                window.location.href = 'management.html';
            } else {
                alert('هذه الخدمة غير مفعلة لشركتكم');
            }
        };

        window.goToAccounting = function() {
            if (hasService('accounting')) {
                window.location.href = 'accounting.html';
            } else {
                alert('هذه الخدمة غير مفعلة لشركتكم');
            }
        };

        window.goToFinancial = function() {
            if (hasService('invoices')) {
                window.location.href = 'financial.html';
            } else {
                alert('هذه الخدمة غير مفعلة لشركتكم');
            }
        };

        window.goToInventory = function() {
            if (hasService('inventory')) {
                // Create inventory page or redirect to existing one
                alert('صفحة المخزون قيد التطوير');
            } else {
                alert('هذه الخدمة غير مفعلة لشركتكم');
            }
        };

        window.goToSales = function() {
            if (hasService('sales')) {
                // Create sales page or redirect to existing one
                alert('صفحة المبيعات قيد التطوير');
            } else {
                alert('هذه الخدمة غير مفعلة لشركتكم');
            }
        };

        // Check if company has specific service
        function hasService(serviceKey) {
            return companyInfo && companyInfo.active_services && 
                   companyInfo.active_services.includes(serviceKey);
        }

        // Logout function
        window.logout = async function() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                await AuthService.signOut();
                window.location.href = 'login.html';
            }
        };

        // Error handling
        function showError(message) {
            const servicesContainer = document.getElementById('servicesContainer');
            servicesContainer.innerHTML = `
                <div class="error-message" style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>حدث خطأ</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        إعادة المحاولة
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
