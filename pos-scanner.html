<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أُفُق - نقطة البيع</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #1E293B;
            --primary-orange: #D97706;
            --secondary-orange: #D9882E;
            --accent-blue: #344663;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --border-gray: #e9ecef;
            --danger-red: #dc3545;
            --success-green: #28a745;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--primary-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-content img {
            width: 50px;
            height: auto;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-back {
            background: var(--accent-blue);
            color: white;
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #reader {
            width: 100%;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            overflow: hidden;
        }

        .manual-input {
            margin-top: 20px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        .cart-items {
            max-height: 400px;
            overflow-y: auto;
        }

        .cart-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .cart-item-code {
            font-size: 12px;
            color: #666;
        }

        .cart-item-price {
            color: var(--primary-orange);
            font-weight: 600;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--primary-orange);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
        }

        .qty-display {
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .remove-btn {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .cart-summary {
            padding: 20px;
            background: var(--light-gray);
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-total {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
            padding-top: 10px;
            border-top: 2px solid var(--border-gray);
        }

        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-cart i {
            font-size: 48px;
            color: var(--border-gray);
            margin-bottom: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="iconWithArabic (2).svg" alt="OFOQ Logo">
                <div class="header-title">
                    <i class="fas fa-qrcode"></i> نقطة البيع
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-back" onclick="cancelSale()">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="grid-container">
            <!-- Scanner Section -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-camera"></i> مسح الباركود
                </div>
                <div id="reader"></div>
                
                <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 12px;">
                    <strong>📱 نصائح المسح:</strong><br>
                    • وجه الكاميرا نحو رمز QR<br>
                    • تأكد من إضاءة جيدة<br>
                    • ابقِ الكاميرا ثابتة<br>
                    • أو استخدم الإدخال اليدوي أدناه
                </div>
                
                <div class="manual-input">
                    <input type="text" class="form-input" id="manualCode" placeholder="أو أدخل رمز المنتج يدوياً...">
                    <button class="btn btn-success" onclick="addManualProduct()" style="width: 100%;">
                        <i class="fas fa-plus"></i> إضافة
                    </button>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-shopping-cart"></i> سلة المشتريات
                </div>
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>السلة فارغة</p>
                        <p style="font-size: 12px; color: #999;">قم بمسح المنتجات لإضافتها</p>
                    </div>
                </div>

                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <div class="summary-row">
                        <span>عدد المنتجات:</span>
                        <span id="itemCount">0</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>الإجمالي:</span>
                        <span id="totalAmount">0.000 ر.ع</span>
                    </div>
                </div>

                <button class="btn btn-success" id="checkoutBtn" onclick="proceedToCheckout()" 
                        style="width: 100%; margin-top: 20px;" disabled>
                    <i class="fas fa-check"></i> متابعة للدفع
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://wlnukwaecpkhxomfgxni.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsbnVrd2FlY3BraHhvbWZneG5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDc4MjEsImV4cCI6MjA3NDIyMzgyMX0.PW3GVs3l15oBIa8rS86offziTFkSVefj5OFUc6XRmoA';
        
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let cart = [];
        let html5QrCode = null;

        // Initialize page
        window.addEventListener('load', async function() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                const { data: profile } = await supabaseClient
                    .from('user_profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();

                if (!profile || profile.role !== 'company') {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = user;
                initializeScanner();
            } catch (error) {
                console.error('Load error:', error);
                window.location.href = 'login.html';
            }
        });

        // Initialize QR Scanner
        function initializeScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            const qrConfig = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            console.log('Starting scanner...');
            
            html5QrCode.start(
                { facingMode: "environment" },
                qrConfig,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                console.log('Scanner started successfully!');
                showAlert('الماسح الضوئي جاهز!', 'success');
            }).catch(err => {
                console.error("Camera error:", err);
                showAlert('تعذر الوصول للكاميرا. استخدم الإدخال اليدوي.', 'error');
            });
        }

        // On scan success
        let lastScannedCode = '';
        let lastScanTime = 0;
        
        async function onScanSuccess(decodedText, decodedResult) {
            console.log('✅ SCAN SUCCESS!');
            console.log('Decoded text:', decodedText);
            console.log('Full result:', decodedResult);
            
            // Prevent duplicate scans within 2 seconds
            const now = Date.now();
            if (decodedText === lastScannedCode && (now - lastScanTime) < 2000) {
                console.log('⏭️ Duplicate scan ignored');
                return;
            }
            
            lastScannedCode = decodedText;
            lastScanTime = now;
            
            console.log('🔍 Scanned code:', decodedText);
            await addProductToCart(decodedText);
        }

        function onScanFailure(error) {
            // Silent - scanning continuously
            // Uncomment below to see scan failures (very verbose)
            // console.log('Scan attempt:', error);
        }

        // Add product to cart
        async function addProductToCart(productCode) {
            try {
                console.log('Searching for product:', productCode);
                
                // Find product in inventory
                const { data: product, error } = await supabaseClient
                    .from('inventory')
                    .select('*')
                    .eq('company_id', currentUser.id)
                    .eq('product_code', productCode)
                    .single();

                if (error || !product) {
                    console.error('Product not found:', error);
                    showAlert('المنتج غير موجود في المخزون: ' + productCode, 'error');
                    
                    // Beep sound for error
                    playBeep(false);
                    return;
                }

                console.log('Product found:', product);

                // Check if already in cart
                const existingItem = cart.find(item => item.product_code === productCode);
                
                if (existingItem) {
                    // Check stock availability
                    if (existingItem.quantity >= product.total_quantity) {
                        showAlert('الكمية المتوفرة غير كافية في المخزون', 'error');
                        playBeep(false);
                        return;
                    }
                    existingItem.quantity++;
                } else {
                    // Check stock
                    if (product.total_quantity <= 0) {
                        showAlert('المنتج غير متوفر في المخزون', 'error');
                        playBeep(false);
                        return;
                    }
                    
                    cart.push({
                        product_code: product.product_code,
                        product_name: product.product_name,
                        unit_price: parseFloat(product.selling_price),
                        quantity: 1,
                        max_quantity: product.total_quantity
                    });
                }

                showAlert('✓ تمت إضافة: ' + product.product_name, 'success');
                playBeep(true);
                renderCart();
            } catch (error) {
                console.error('Add product error:', error);
                showAlert('خطأ في إضافة المنتج', 'error');
                playBeep(false);
            }
        }
        
        // Play beep sound
        function playBeep(success) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = success ? 800 : 400;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Add manual product
        async function addManualProduct() {
            const code = document.getElementById('manualCode').value.trim();
            if (!code) {
                showAlert('الرجاء إدخال رمز المنتج', 'error');
                return;
            }
            
            await addProductToCart(code);
            document.getElementById('manualCode').value = '';
        }

        // Allow Enter key for manual input
        document.getElementById('manualCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addManualProduct();
            }
        });

        // Render cart
        function renderCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>السلة فارغة</p>
                        <p style="font-size: 12px; color: #999;">قم بمسح المنتجات لإضافتها</p>
                    </div>
                `;
                document.getElementById('cartSummary').style.display = 'none';
                document.getElementById('checkoutBtn').disabled = true;
                return;
            }

            cartItemsDiv.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.product_name}</div>
                        <div class="cart-item-code">${item.product_code}</div>
                        <div class="cart-item-qty">
                            <button class="qty-btn" onclick="decreaseQuantity(${index})">-</button>
                            <span class="qty-display">${item.quantity}</span>
                            <button class="qty-btn" onclick="increaseQuantity(${index})">+</button>
                        </div>
                        <div class="cart-item-price">${(item.unit_price * item.quantity).toFixed(3)} ر.ع</div>
                    </div>
                    <button class="remove-btn" onclick="removeItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            // Update summary
            const total = cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
            document.getElementById('itemCount').textContent = cart.length;
            document.getElementById('totalAmount').textContent = total.toFixed(3) + ' ر.ع';
            document.getElementById('cartSummary').style.display = 'block';
            document.getElementById('checkoutBtn').disabled = false;
        }

        // Increase quantity
        function increaseQuantity(index) {
            if (cart[index].quantity >= cart[index].max_quantity) {
                showAlert('الكمية المتوفرة غير كافية في المخزون', 'error');
                return;
            }
            cart[index].quantity++;
            renderCart();
        }

        // Decrease quantity
        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                renderCart();
            }
        }

        // Remove item
        function removeItem(index) {
            cart.splice(index, 1);
            renderCart();
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            
            // Save cart to session storage
            sessionStorage.setItem('pendingSale', JSON.stringify(cart));
            window.location.href = 'sale-review.html';
        }

        // Cancel sale
        function cancelSale() {
            if (cart.length > 0) {
                if (confirm('هل أنت متأكد من إلغاء البيع؟')) {
                    window.location.href = 'sales.html';
                }
            } else {
                window.location.href = 'sales.html';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
        });
    </script>
</body>
</html>
